function Entity(n,t){function r(n){for(var t,u,o,f=[],e=n.Attributes.$values,r=0;r<e.length;r++)t=e[r],u=i(t.Key),u!=undefined&&t!=undefined&&(o=new Attribute(u,t),f.push(o));return f}function i(n){for(var r=t.Attributes.$values,i=0;i<r.length;i++)if(r[i].LogicalName==n)return r[i]}this._meta=t;this._ent=n;this._getAttrMetadata=i;this.guid=n.Id;this.logicalName=n.LogicalName;this.attributes=r(n,t)}function Attribute(n,t){if(this._meta=n,this._attr=t,this.val=undefined,this.logicalName=n.LogicalName,this.label=n.DisplayName.UserLocalizedLabel.Label,this.type=n.$type.split(",")[0].replace("Microsoft.Xrm.Sdk.Metadata.",""),this.options=new AttributeOptions(n),this.validCreate=n.IsValidForCreate,this.validUpdate=n.IsValidForUpdate,this.required=n.RequiredLevel.Value>0,t!==undefined){var i=this.type;switch(i){case"StatusAttributeMetadata":case"StateAttributeMetadata":case"PicklistAttributeMetadata":this.val=t.Value.Value;break;case"BigIntAttributeMetadata":case"BooleanAttributeMetadata":case"DoubleAttributeMetadata":case"DecimalAttributeMetadata":case"IntegerAttributeMetadata":case"StringAttributeMetadata":case"MemoAttributeMetadata":case"AttributeMetadata":this.val=t.Value;break;case"DateTimeAttributeMetadata":this.val=moment(t.Value).format("MMMM Do YYYY, h:mm:ss a");break;case"LookupAttributeMetadata":this.val=t.Value.Id}}else this.val=""}function AttributeOptions(n){function t(n){var f=[],t=[],i,u,r;for(n.Options!=undefined&&n.Options.$values?t=n.Options.$values:n.FalseOption!=undefined&&n.TrueOption!=undefined&&(t=[n.FalseOption,n.TrueOption]),i=0;i<t.length;i++)u=t[i],r={},r.label=u.Label.UserLocalizedLabel.Label,r.val=u.Value,f.push(r);return f}this._meta=n.OptionSet;this.opts=this._meta===undefined?[]:t(this._meta)}Entity.prototype.getViewAttributes=function(n){for(var r,u,i=[],t=0;t<n.length;t++)r=n[t],u=this.getAttribute(r),i.push(u);return i};Entity.prototype.getAttribute=function(n){for(var i,t=0;t<this.attributes.length;t++)if(this.attributes[t].logicalName==n)return this.attributes[t];return i=this._getAttrMetadata(n),new Attribute(i,undefined)};Attribute.prototype.getDisplay=function(){var n=this.val===undefined?"":this.val,t,i;if(this._attr==undefined)return n;if(this.type=="LookupAttributeMetadata")n=this._attr.Value.Name;else for(t=0;t<this.options.opts.length;t++)if(i=this.options.opts[t],i.val===n){n=i.label;break}return n===undefined?"":n};Attribute.prototype.getViewHtml=function(){var n=this.getDisplay();return"<span>"+n+"<\/span>"};Attribute.prototype.getUpsertHtml=function(){var n=$(),o=this.type,f,i,r,t,u,e;switch(o){case"StatusAttributeMetadata":case"StateAttributeMetadata":case"PicklistAttributeMetadata":for(f=this.options.opts,n=$("<select />"),n.attr({name:this.logicalName}),i=0;i<f.length;i++)r=f[i],t=$("<option />"),t.val(r.val),t.text(r.label),this.val===r.val&&t.attr("selected","selected"),n.append(t);break;case"BigIntAttributeMetadata":case"BooleanAttributeMetadata":case"DoubleAttributeMetadata":case"DecimalAttributeMetadata":case"IntegerAttributeMetadata":case"StringAttributeMetadata":case"AttributeMetadata":n=$("<input />");n.attr({"data-type":this.type,name:this.logicalName});n.val(this.val);break;case"MemoAttributeMetadata":n=$("<textarea />");n.attr({"data-type":this.type,name:this.logicalName});n.val(this.val);break;case"DateTimeAttributeMetadata":n=$("<input />");n.attr({"data-type":this.type,name:this.logicalName});n.val(this.val)}return u=n,n.length>0&&(u=$('<div class="fieldset" />'),e=$("<label>").text(this.label).attr("data-required",this.required),u.append(e).append(n)),u};Attribute.prototype.isValid=function(){var n=!1;if(this.required&&this.val.trim()==="")return!1;switch(this.type){case"BooleanAttributeMetadata":case"StatusAttributeMetadata":case"StateAttributeMetadata":case"PicklistAttributeMetadata":n=this.options.CheckOptionValid(this.val);break;case"BigIntAttributeMetadata":case"IntegerAttributeMetadata":case"DoubleAttributeMetadata":case"DecimalAttributeMetadata":n=$.isNumeric(this.val);break;case"StringAttributeMetadata":case"MemoAttributeMetadata":n=!0;break;case"DateTimeAttributeMetadata":return moment(this.val).isValid()}return n};Attribute.prototype.getUpsertObject=function(){var n={Key:this.logicalName},t=this.type;switch(t){case"StatusAttributeMetadata":case"StateAttributeMetadata":case"PicklistAttributeMetadata":n.Value={$type:"Microsoft.Xrm.Sdk.OptionSetValue, Microsoft.Xrm.Sdk",Value:this.val};break;case"BigIntAttributeMetadata":case"BooleanAttributeMetadata":case"DoubleAttributeMetadata":case"DecimalAttributeMetadata":case"IntegerAttributeMetadata":case"StringAttributeMetadata":case"MemoAttributeMetadata":case"AttributeMetadata":n.Value=this.val;break;case"DateTimeAttributeMetadata":n.Value=moment(this.val).toISOString()}return n};AttributeOptions.prototype.CheckOptionValid=function(n){for(var i,t=0;t<this.opts.length;t++)if(i=this.opts[t],i.val===Number(n))return!0;return!1};

(function(n){function e(){return"withCredentials"in new XMLHttpRequest?!0:!1}var t={url:undefined,baseApiUri:"api",ready:!1,iframe:undefined},i=[];n.p2c=function(u,e,o){if(e)return r(u);var h=r(u),s=o===undefined?n.Deferred():o;return h.done(function(n,t){s.resolve(n,t)}).fail(function(r,e){e==401||r.status==401?(console.log("Got a 401, added to queue"),i.push([u,s]),t.ready===!0&&(t.ready=!1,f(function(){var r,u,f;for(console.log("Reauthed"),t.ready=!0,r=0;r<i.length;r++)u=i[r][0],f=i[r][1],n.p2c(u,!1,f)}))):s.reject(r,e)}),s};n.p2c.evs=n("<div />");n.p2c.config=function(n){t.url=u(n.url)};n.p2c.init=function(){function r(){n.p2c.evs.trigger("ready");t.ready=!0}var i=o(t);i&&f(r)};n.p2c.ready=function(i){if(t.ready){n.p2c.evs.off("ready");n.p2c.evs.on("ready",i);n.p2c.evs.trigger("ready");return}n.p2c.evs.on("ready",i)};var r=function(i){function h(n){var i=u(t.url.href),e,f,r;return i.pathname=t.baseApiUri,e=i.pathname,i.pathname=n,f=i.pathname,i.pathname=f,r=e+"/"+f,r=r.replace("//","/"),i.pathname=r,i.href}function c(i){var u=n.Deferred(),f,r,e;if(t.iframe.length<1){console.log("Error, iframe not found");return}f=t.iframe[0].contentWindow;r=Date.now();n(window).on("message.ajax."+r,function(t){var o=t.originalEvent.data,i,f,e;try{i=JSON.parse(o)}catch(s){}i!==undefined&&i.id==r&&(n(window).off("message.ajax."+r),f=i.status,e=i.payload,f<300&&u.resolve(e,f),u.reject(e,f))});return e={p2cAction:"ajax",id:r,payload:i},f.postMessage(JSON.stringify(e),"*"),u}var f=h(i.url),o=i.type,s=i.data,r={url:f,type:o,data:s};return e()?(r.xhrFields={withCredentials:!0},n.ajax(r)):c(r)},u=function(n){var t=document.createElement("a");return t.href=n,t},o=function(n){var t=!0,i="";return n.url==undefined&&(i+="Url is empty. \n",t=!1),t||(console.log("P2C not properly initialized:"),console.log(i)),t},s=function(){try{return window.self!==window.top}catch(n){return!0}},f=function(i){function r(){return e()?n.ajax({url:t.url+"api/auth",type:"get",xhrFields:{withCredentials:!0},contentType:"text/html"}):n.Deferred().reject()}function u(){var r,i;n(i).remove();r=new n.Deferred;n(window).off("message.auth");n(window).on("message.auth",function(n){var t=n.originalEvent.data;t=="ready"&&r.resolve()});return i=n("<iframe />"),i.attr({src:t.url+"Auth.aspx",id:"authP2C"}),i.attr("style","display:none !important"),i.appendTo("body"),t.iframe=i,r}if(s()){parent.postMessage("sso","*");return}r().done(function(){i()}).fail(function(){u().done(function(){i()})})}})(jQuery);

function getFriendlyAttributeNames(n,t){for(var i,u=[],f=n.Attributes.$values,r=0;r<f.length;r++)if(i=f[r],t.indexOf(i.LogicalName)>-1){var e={},o=i.LogicalName,s=i.DisplayName.UserLocalizedLabel.Label;e[o]=s;u.push(e)}return _.sortBy(u,function(n){return _.indexOf(t,Object.keys(n)[0])})}function getIncidentMetadata(){var n=$.Deferred(),t="metadata/incident",i=p2cSessStoreGet(t);return i==undefined?$.p2c({url:"metadata/incident",type:"get"}).done(function(i){p2cSessStorePut(t,i);n.resolve([i])}).fail(function(t){n.reject([t])}):n.resolve([i]),n}function getSavedView(n){var t=$.Deferred(),i="savedquery-"+n,r=p2cSessStoreGet(i);return r==undefined?$.p2c({url:"savedquery",data:{viewName:n},type:"get"}).done(function(n){p2cSessStorePut(i,n);t.resolve([n])}).fail(function(n){t.reject([n])}):t.resolve([r]),t}function getCommentsMetadata(){var n=$.Deferred(),t="metadata/new_casecomments",i=p2cSessStoreGet(t);return i==undefined?$.p2c({url:"metadata/new_casecomments",type:"get"}).done(function(i){p2cSessStorePut(t,i);n.resolve([i])}).fail(function(t){n.reject([t])}):n.resolve([i]),n}function getEntity(n,t){return $.p2c({url:"entity/"+n+"/"+t,type:"get"})}function getRelatedEntities(n,t,i){return $.p2c({url:"entity/"+n+"/"+t+"/"+i,type:"get"})}function getViewArr(n){return _.map(n.layoutXml.grid.row.cell,function(n){return n["@name"]})}function getViewOrder(n){return n.fetchXml.fetch.entity.order}function createEntity(n,t){return $.p2c({url:"entity/"+n,data:JSON.stringify(t),type:"post"})}function createRelatedEntity(n,t,i,r){return $.p2c({url:"entity/"+n+"/"+t+"/"+i,data:JSON.stringify(r),type:"post"})}function createInsertObj(n,t){for(var r={$type:"Microsoft.Xrm.Sdk.AttributeCollection, Microsoft.Xrm.Sdk",$values:[]},i=0;i<n.length;i++){var u=n[i],e=getAttrMetadata(u.name,t),f=new Attribute(e,undefined);f.val=u.value;r.$values.push(f.getUpsertObject())}return r}function getTableViewOrder(n,t){Object.prototype.toString.call(t)!=="[object Array]"&&(t=[t]);return _.map(t,function(t){var i,r,u;if(t["@descending"]==="true")i="desc";else if(t["@descending"]==="false")i="asc";else return!1;return r=n.indexOf(t["@attribute"]),u=[r,i],u})}function getFormFields(n,t){for(var u,f,r=$("<div />"),i=0;i<n.length;i++)u=getAttrMetadata(n[i],t),f=new Attribute(u,undefined),r.append(f.getUpsertHtml());return r.children()}function getAttrMetadata(n,t){for(var r=t.Attributes.$values,i=0;i<r.length;i++)if(r[i].LogicalName==n)return r[i]}function addSubmitButton(n,t,i){var r=$('<button type="button" class="crmSubmit">Submit<\/submit>');r.appendTo(n);r.on("click",function(){var u=n.serializeArray(),f,e;if(formDisabledState(n,"disabled"),f=validValues(u,t),!f)return alert("Invalid Fields set in the form. Please correct."),formDisabledState(n,""),!1;e=createInsertObj(u,t);createEntity(t.LogicalName,e).done(function(n){i(n)}).fail(function(){n.remove();r.remove()})});return r}function addRelatedSubmitButton(n,t,i,r,u){var f=$('<button type="button" class="crmSubmit">Submit<\/submit>');f.appendTo(n);f.on("click",function(){var e=n.serializeArray(),o,s;if(formDisabledState(n,"disabled"),o=validValues(e,r),!o)return alert("Invalid Fields set in the form. Please correct."),formDisabledState(n,""),!1;s=createInsertObj(e,r);createRelatedEntity(t.LogicalName,i,r.LogicalName,s).done(function(n){return u(n),!1}).fail(function(){n.remove();f.remove()})});return f}function validValues(n,t){for(var i=0;i<n.length;i++){var r=n[i],f=getAttrMetadata(r.name,t),u=new Attribute(f,undefined);if(u.val=r.value,u.isValid()===!1)return!1}return!0}function formDisabledState(n,t){$(n).find("input, textarea, button, select").prop("disabled",t)}function p2cSessStoreGet(n){var t=sessionStorage.getItem(p2cSessStoreId+n);try{return JSON.parse(t)}catch(i){}return undefined}function p2cSessStorePut(n,t){var i=JSON.stringify(t);sessionStorage.setItem(p2cSessStoreId+n,i)}function p2cSessStoreClear(){for(var t,i=Object.keys(sessionStorage),n=0;n<i.length;n++)t=i[n],t.indexOf(p2cSessStoreId)===0&&delete sessionStorage[t]}var detailsModal,p2cSessStoreId="%P2C%_";$.p2c.ready(function(){function e(){return $.p2c({url:"entity/incident",type:"get"})}function o(r,f,e){var h=_.map(f,function(t){for(var r,f,u={},i=0;i<n.length;i++)r=n[i],f=t.getAttribute(r).getDisplay(),u[r]=f;return u}),s=f.length>0?f[0]:undefined,o=_.map(e,function(n){var t=Object.keys(n)[0],i={data:t,title:n[t]},r;return s!=undefined&&(r=s.getAttribute(t).type,i.type=r),i}),c=getTableViewOrder(n,u);r.dataTable({data:h,columns:o,order:c,pageLength:5,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],fnCreatedRow:function(n){$(n).children().each(function(n){var r=$(this);if(r.attr("data-logicalname",o[n].data),o[n].data=="ticketnumber")r.on("click",function(){var n=$(this).text(),r=_.find(t,function(t){return t.getAttribute("ticketnumber").val==n});$.p2c.evs.trigger("details",[r.guid,i])})})}})}function s(n){for(var i=$("<tr />"),t=0;t<n.length;t++){var r=Object.keys(n[t])[0],u=n[t][r],f=$("<th />").text(u).attr({"data-logicalname":r});i.append(f)}return i=$("<thead />").append(i),$('<table class="tableList ticketlist" id="viewTable" />')}var t,i,n,u,r=$('<div id="p2c-cases" class="p2c-loading" />'),f=$("div#myTicketHistory, form#myTicketSearchForm");f.length>0&&(r.insertBefore(f),$.when(e(),getIncidentMetadata(),getSavedView("P2CCaseView")).done(function(f,e,h){var l,c,y,a,v;for(r.removeClass("p2c-loading"),i=e[0],n=getViewArr(h[0]),u=getViewOrder(h[0]),l=f[0].Entities.$values||[],t=[],c=0;c<l.length;c++)y=new Entity(l[c],i),t.push(y);a=getFriendlyAttributeNames(i,n);v=s(a);v.appendTo(r);o(v,t,a)}))});$.p2c.ready(function(){function o(n){for(var i="//"+location.hostname+"/ics/support/KBResult.asp?searchOption=anywords&questionID=&searchTime=-1&task=knowledge&resultLimit=50&pageContentIdentifier=&submitsearch=Search&searchFor=",r="",t=0;t<n.length;t++)r+=n[t]+" ";return i+=encodeURIComponent(r),$.get(i)}var u,f,i,n,r,t,e=$('form[action="ticketNewProcess.asp"]');e.length>0&&(n=$('<form id="caseCreate" class="p2c-loading"><\/form>'),n.insertBefore('form[action="ticketNewProcess.asp"]'),$.when(getSavedView("PortalCaseCreate"),getIncidentMetadata()).done(function(e,s){var c,h;n.removeClass("p2c-loading");u=getViewArr(e[0]);f=getViewOrder(e[0]);i=s[0];c=getFormFields(u,i);n.append(c);r=addSubmitButton(n,i,function(i){var u=$('<div id="createCaseConf">');u.attr("data-incidentid",i);u.text("Case created successfully.");u.insertBefore(n);n.remove();r.remove();t.children().remove()});t=$('<div id="EasyAnswerContainer">').insertBefore(r);h=n.find("input, textarea");h.on("change",function(){var n,i;t.children().remove();n=[];h.each(function(t,i){n.push($(i).val())});i=o(n);i.done(function(n){var i=$(".searchResults",n).outerHTML();t.append(i)})})}))});$.p2c.evs.on("details",function(n,t,i){function e(){detailsModal=$('<div id="caseDetails" class="p2c-loading"><div id="frameContents" style="width: 100%;"><\/div><span id="detailsClose">X<\/span><\/div>').appendTo("body");detailsModal.find("#detailsClose").on("click",function(){var n=detailsModal.children("div#frameContents");n.children().remove();detailsModal.addClass("hidden");detailsModal.children("img.loader").removeClass("hidden")})}function o(){var n=$('<form id="caseDetails" />');return n.appendTo(detailsModal.find("#frameContents")),n}function s(n){for(var t,o,s=new Entity(n,i),f=s.getViewAttributes(r),e=$("<div />"),u=0;u<f.length;u++)t=f[u],o=$('<div class="fieldset"/>').attr("data-logicalName",t.logicalName).append($("<label><\/label>").text(t.label)).append(t.getViewHtml()),e.append(o);return e.children()}var r,f,u;$(detailsModal).length>0&&$(detailsModal).remove();e();$.when(getSavedView("PortalCaseDetails"),getEntity("incident",t)).done(function(n,t){var e,h,c;detailsModal.removeClass("p2c-loading");r=getViewArr(n[0]);f=getViewOrder(n[0]);e=t[0];u=getFriendlyAttributeNames(i,r);h=o();c=s(e,u);h.append(c);$.p2c.evs.trigger("caseComments",[e.Id,i])})});$.p2c.evs.on("caseComments",function(n,t,i){function o(n){for(var t=$("<tr />"),i=0;i<n.length;i++){var r=Object.keys(n[i])[0],u=n[i][r],f=$("<th />").text(u).attr({"data-logicalname":r});t.append(f)}return t=$("<thead />").append(t),$('<table class="tableList" id="commentsTable" />').append(t)}function s(n,t,i){var e=_.map(t,function(n){for(var i,f,r={},t=0;t<u.length;t++)i=u[t],f=n.getAttribute(i).getDisplay(),r[i]=f;return r}),r=_.map(i,function(n){var t=Object.keys(n)[0];return{data:t,title:n[t]}}),o=getTableViewOrder(u,f);n.dataTable({data:e,columns:r,order:o,pageLength:3,lengthMenu:[[3,5],[3,5]],fnCreatedRow:function(n){$(n).children().each(function(n){var t=$(this);t.attr("data-logicalname",r[n].data)})}})}function e(n,t){var u=r.find("ul.tabsMenu").children().length,i;r.find("ul.tabsMenu").append('<li><a href="#tab-'+u+'">'+n+"<\/a><\/li>");i=$('<div id="tab-'+u+'" class="tabContent"><\/div>');i.append(t);r.find("div.tabs").append(i)}function h(){r.find("ul.tabsMenu li").eq(0).addClass("current");r.find(".tabContent").eq(0).show();r.find("ul.tabsMenu a").click(function(n){n.preventDefault();$(this).parent().addClass("current");$(this).parent().siblings().removeClass("current");var t=$(this).attr("href");r.find(".tabContent").not(t).css("display","none");$(t).show()})}$("div#tabContainer").remove();var r=$('<div id="tabContainer"><ul class="tabsMenu"><\/ul><div class="tabs"><\/div>'),u,f;$.when(getRelatedEntities("incident",t,"new_casecomments"),getSavedView("P2C_PortalView"),getCommentsMetadata(),getSavedView("P2C_PortalCreateComment")).done(function(n,c,l,a){for(var b,v=l[0],p=n[0].Entities.$values,w=[],y=0;y<p.length;y++)b=new Entity(p[y],v),w.push(b);u=getViewArr(c[0]);f=getViewOrder(c[0]);var nt=getViewArr(a[0]),k=getFriendlyAttributeNames(v,u),d=o(k),g=$("<form />").append(getFormFields(nt,v));addRelatedSubmitButton(g,i,t,v,function(){$.p2c.evs.trigger("caseComments",[t,i])});r.appendTo(detailsModal.find("#frameContents"));e("All Comments",d);e("Submit Comment",g);s(d,w,k);h()})});$(window).load(function(){function t(){return $.p2c({url:"auth",type:"DELETE"})}var n=window.exitSupport;window.exitSupport=function(){setTimeout(function(){n.apply(this,arguments)},1500);p2cSessStoreClear();t().done(function(){n.apply(this,arguments)})}});$.fn.dataTableExt.sErrMode="throw";$.extend(jQuery.fn.dataTableExt.oSort,{"DateTimeAttributeMetadata-pre":function(n){return $.trim(n)!=""?moment(n,"MMMM Do YYYY, h:mm:ss a").unix():0},"DateTimeAttributeMetadata-asc":function(n,t){return n-t},"DateTimeAttributeMetadata-desc":function(n,t){return t-n}});